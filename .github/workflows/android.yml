steps:
  - name: Checkout Repository
    uses: actions/checkout@v3

  - name: Set up JDK
    uses: actions/setup-java@v3
    with:
      distribution: temurin
      java-version: 17

  - name: Set up Android SDK
    uses: android-actions/setup-android@v2
    with:
      api-level: 30
      target: google_apis
      arch: x86_64
      ndk: false

  - name: Grant Permission to Gradlew
    run: chmod +x ./gradlew

  - name: Build Debug APK and Android Test APK
    run: ./gradlew :app:assembleDebug :app:assembleAndroidTest

  - name: Start Android Emulator
    uses: reactivecircus/android-emulator-runner@v2
    with:
      api-level: 30
      target: google_apis
      arch: x86_64
      profile: pixel_2
      disable-animations: true
      emulator-options: "-no-window -no-audio -no-boot-anim -gpu swiftshader_indirect"

  - name: Wait for Emulator
    run: adb wait-for-device

  - name: Run Unit Tests
    run: ./gradlew testDebugUnitTest

  - name: Run Instrumentation Tests
    run: ./gradlew connectedDebugAndroidTest

  - name: Upload Test Reports
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: test-reports
      path: |
        app/build/reports/tests/testDebugUnitTest/
        app/build/reports/androidTests/connected/
